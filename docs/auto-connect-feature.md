# 自動接続機能

## 概要

Azure Personal Voice Playground では、ブラウザの localStorage に保存されたサブスクリプションキーとサービスリージョンを検出した場合、自動的に Azure Speech Service への接続を試行する機能を実装しています。

## 機能詳細

### 1. 自動接続の動作フロー

**ページ読み込み時:**

1. localStorage から保存された認証情報を読み込む
2. 認証情報が存在する場合:
   - 入力フィールドに自動入力
   - 接続パネルを折りたたむ
   - 自動的に接続試験を実行
3. 認証情報が存在しない場合:
   - 接続パネルを開いた状態で表示（従来の動作）

**自動接続試験中:**

- 接続ステータスに「自動接続中...」と表示
- スピナーアイコンを表示してユーザーに進行状況を通知

**自動接続成功時:**

- 接続ステータスに「自動接続成功！」と表示
- トースト通知「保存された設定で自動接続しました」を表示
- メインコンテンツパネルを自動的に表示
- Personal Voice リストを自動的に読み込み

**自動接続失敗時:**

- 接続ステータスに「自動接続失敗 - 手動で接続してください」と表示
- トースト通知「自動接続に失敗しました。設定を確認して手動で接続してください」を表示
- 接続パネルを自動的に展開してユーザーに手動接続を促す
- メインコンテンツは非表示のまま

### 2. ユーザー体験の向上

**初回アクセス時:**

- 接続パネルが展開された状態
- ユーザーが認証情報を入力して「接続」ボタンをクリック
- 接続成功後、認証情報が自動的に保存される

**2回目以降のアクセス:**

- ページを開くと自動的に接続試験が開始
- 接続成功すればすぐにメインパネルが表示される
- 毎回認証情報を入力する手間が不要
- シームレスなユーザー体験を提供

### 3. エラーハンドリング

自動接続が失敗した場合でも、ユーザーは手動で接続できます:

- 保存された認証情報が入力フィールドに表示される
- 接続パネルが自動的に展開される
- ユーザーは設定を確認・修正して再度接続できる

## 技術仕様

### 新規追加された関数

#### autoConnect()

保存された認証情報を使用して自動的に Azure Speech Service への接続を試行します。

```javascript
async function autoConnect() {
    // 1. 入力フィールドから認証情報を取得
    // 2. 接続試験を実行（プロジェクトリストの取得を試行）
    // 3. 成功時: メインコンテンツを表示、Voice リストを読み込み
    // 4. 失敗時: 接続パネルを展開、エラーメッセージを表示
}
```

**主な特徴:**
- 非同期処理による接続試験
- 詳細なコンソールログ出力
- 適切なUIフィードバック（スピナー、ステータス、トースト通知）
- 失敗時の自動リカバリー（接続パネルの展開）

#### expandConnectionPanel()

接続パネルを展開状態にします。

```javascript
function expandConnectionPanel() {
    // 接続パネルを展開
    // フォームを表示
    // トグルボタンを非表示
}
```

**使用場面:**
- 自動接続失敗時
- ユーザーが「表示」ボタンをクリック時（既存機能）

### 変更された関数

#### loadSavedSettings()

保存された設定を読み込む際に、自動接続を試行するように拡張されました。

```javascript
function loadSavedSettings() {
    // 1. localStorage から認証情報を読み込み
    // 2. 認証情報が存在する場合:
    //    - 入力フィールドに設定
    //    - 接続パネルを折りたたむ
    //    - autoConnect() を呼び出す（新規追加）
    // 3. 認証情報が存在しない場合:
    //    - 接続パネルを開いた状態を維持
}
```

### コンソールログ

自動接続機能は詳細なコンソールログを出力します:

**成功時のログ例:**
```
保存された設定を読み込んでいます...
保存された設定が見つかりました
リージョン: eastus
接続パネルを折りたたんでいます...
保存された設定をフィールドに設定し、接続パネルを閉じました
自動接続を試行します...
自動接続を開始しています...
自動接続: リージョン eastus に接続しています...
自動接続: 接続テストのレスポンスステータス: 200
自動接続: Azure Speech Service への接続に成功しました
Personal Voice リストを更新しています...
```

**失敗時のログ例:**
```
保存された設定を読み込んでいます...
保存された設定が見つかりました
リージョン: eastus
接続パネルを折りたたんでいます...
保存された設定をフィールドに設定し、接続パネルを閉じました
自動接続を試行します...
自動接続を開始しています...
自動接続: リージョン eastus に接続しています...
自動接続エラー: [エラー詳細]
トースト通知: 自動接続に失敗しました。設定を確認して手動で接続してください (タイプ: error)
接続パネルを展開しています...
```

## 使用方法

### 通常の使用フロー

1. **初回アクセス:**
   - サブスクリプションキーとリージョンを入力
   - 「接続」ボタンをクリック
   - 接続成功すると設定が自動保存される

2. **2回目以降のアクセス:**
   - ページを開く
   - 自動接続が開始される（ユーザーの操作不要）
   - 接続成功すればメインパネルが自動表示される

### 認証情報の変更

保存された認証情報を変更する必要がある場合:

1. 接続パネルの「表示」ボタンをクリック
2. サブスクリプションキーまたはリージョンを修正
3. 「接続」ボタンをクリック
4. 新しい設定が自動的に保存される

### 自動接続のスキップ

自動接続を無効にしたい場合:

1. ブラウザの開発者ツールを開く（F12）
2. コンソールで以下を実行:
   ```javascript
   localStorage.removeItem('azureSpeech_subscriptionKey');
   localStorage.removeItem('azureSpeech_serviceRegion');
   ```
3. ページをリロード

## セキュリティとプライバシー

### 重要な注意事項

⚠️ **本機能はテスト・デモ用途を想定しています**

- 自動接続は保存された認証情報を使用して API リクエストを送信します
- 認証情報は localStorage に平文で保存されています
- 共有PCや公共の環境では使用しないでください

### セキュリティのベストプラクティス

1. **個人のPC でのみ使用する**
   - 共有環境では localStorage をクリアすることをお勧めします

2. **定期的なキーのローテーション**
   - Azure Portal でサブスクリプションキーを定期的に再生成してください

3. **本番環境での使用について**
   - 本番環境では、より安全な認証方式（Azure AD、Managed Identity など）の使用を検討してください
   - バックエンドサーバーを経由した API 呼び出しを推奨します

## トラブルシューティング

### 自動接続が毎回失敗する

**原因:**
- 保存された認証情報が無効
- ネットワーク接続の問題
- Azure Speech Service のサービス停止

**解決策:**
1. Azure Portal で認証情報を確認
2. 正しいサブスクリプションキーとリージョンを再入力
3. 「接続」ボタンで手動接続を試行
4. Azure のサービス稼働状況を確認

### 自動接続が実行されない

**原因:**
- localStorage に認証情報が保存されていない
- ブラウザのプライベートモード使用中

**解決策:**
1. 開発者ツールのコンソールで localStorage を確認:
   ```javascript
   console.log(localStorage.getItem('azureSpeech_subscriptionKey'));
   console.log(localStorage.getItem('azureSpeech_serviceRegion'));
   ```
2. 通常モードのブラウザを使用
3. 認証情報を入力して手動接続を実行

### 接続パネルが展開されたまま

**原因:**
- 自動接続に失敗している（設計上の動作）

**解決策:**
1. コンソールログでエラー内容を確認
2. 認証情報を確認・修正
3. 「接続」ボタンで再度接続を試行

## まとめ

自動接続機能により、2回目以降のアクセス時にユーザーは認証情報を入力する必要がなく、ページを開くだけですぐにアプリケーションを使用できるようになりました。この機能は以下の点でユーザー体験を向上させます:

- **利便性の向上:** 毎回の認証情報入力が不要
- **時間の節約:** 自動的に接続試験が完了
- **シームレスな体験:** 成功時は即座にメインパネルが表示
- **適切なエラーハンドリング:** 失敗時も手動接続が可能

ただし、セキュリティ上の制限があるため、テスト・デモ用途でのみ使用し、本番環境ではより安全な認証方式を検討してください。
